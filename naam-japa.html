<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Naam Japa Counter • Radha–Krishna</title>
  <link href="https://fonts.googleapis.com/css2?family=Tiro+Devanagari+Hindi:wght@700&display=swap" rel="stylesheet">
  
<style>



  /* Bubble (handles floating/position/size) */
  .bubble{
    position:absolute;
    bottom:0px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
    opacity:0;
    width: var(--b-size,72px);
    height: var(--b-size,72px);
    animation: float var(--b-duration,7s) linear forwards;
  }
 

  .bubble-inner{
    width:100%; height:100%;
    border-radius:50%;
    display:flex; 
    align-items:center; 
    justify-content:center;
    flex-direction:column;
    animation: rotateBubble var(--b-rot,4s) ease-in-out infinite;
    position:relative;
    overflow:hidden;
    text-align:center;
  }

  /* Text inside bubble */
  .bubble-inner span, .mantra{
    font-family: "Tiro Devanagari Hindi", serif;
    font-weight:700;
    background: linear-gradient(180deg,#fff9dc 0%,#ffe28a 35%,#f0c24d 58%,#b88917 82%,#fff6c4 100%);
    -webkit-background-clip:text;
            background-clip:text;
    color:transparent;
    text-shadow:0 1px 2px rgba(0,0,0,.35),0 4px 10px rgba(255,208,96,.4);
    user-select:none;
    line-height:1.2;
    white-space:nowrap;
    word-break:keep-all;
    display:block;
  }

  .star{
    position:absolute;
    background: radial-gradient(circle, #fffef6 0%, #ffeab6 40%, rgba(255,215,120,0.8) 70%, transparent 100%);
    border-radius:50%;
    pointer-events:none;
    filter: drop-shadow(0 0 5px #fff6d5) drop-shadow(0 0 12px #ffd26a);
  }

  /* SHOOTING STAR */
  .shooting-star {
    position: absolute;
    width: 120px;
    height: 2px;
    background: linear-gradient(90deg, rgba(255,240,200,1) 0%, rgba(255,210,100,0.7) 50%, transparent 100%);
    border-radius: 50%;
    opacity: 0;
    pointer-events: none;
    transform: rotate(-45deg);
    animation: shooting 2s ease-out forwards;
  }

  /* Float up animation (translate only) */
  
  @keyframes rotateBubble {
    0%   { transform: rotate(0deg) scale(1); }
    25%  { transform: rotate(5deg) scale(1.03); }
    50%  { transform: rotate(0deg) scale(1); }
    75%  { transform: rotate(-5deg) scale(0.97); }
    100% { transform: rotate(0deg) scale(1); }
  }

  @keyframes float {
    0%   { transform: translateY(0) scale(0.8); opacity:0; }
    10%  { opacity:1; }
    90%  { opacity:0.9; }
    100% { transform: translateY(-120vh) scale(1.05); opacity:0.8; }
  }

  @keyframes twinkle {
    0%   { transform:scale(0.8); opacity:0.6; }
    50%  { transform:scale(1.4); opacity:1; }
    100% { transform:scale(0.8); opacity:0.6; }
  }

  @keyframes shooting {
    0%   { transform: translateX(0) translateY(0) rotate(-45deg); opacity:1; }
    100% { transform: translateX(300px) translateY(-300px) rotate(-45deg); opacity:0; }
  }

</style>



<script>
  
  const words = [
  "कृष्ण", "श्याम", "राधा",
  "मुरारी", "गिरि धारी", "राधा",
  "माधव", "बाल गोपाल", "राधा",
  "वल्लभ", "गो विंद", "राधा",
  "घन श्याम", "कान्हा", "राधा",
  "बनवारी", "राधे श्याम", "राधा",
  "गोपाल", "देवकी नंदन", "राधा",
  "नंदलाल", "यशोदा नंदन", "राधा",
  "श्री हरि", "माखन चोर", "राधा",
  "बांसुरी वाले", "रास बिहारी", "राधा",
  "लड्डू गोपाल", "श्याम सुंदर", "राधा",
  "प्रियतम", "घनश्याम सुंदर", "राधा",
  "कान्हैया", "राधा वल्लभ", "राधा",
  "श्री कृष्ण", "कान्ह", "राधा",
  "वृन्दावन बिहारी", "गोपी नाथ", "राधा",
  "रास रंग", "हरि वल्लभ", "राधा",
  "मुरली धर", "गोवर्धन धारी", "राधा",
  "किशन", "माखन चोर", "राधा",
  "गोकुल नाथ", "व्रजेश", "राधा",
  "रासेश", "मुरली मनोहर", "राधा",
  "श्री नाथ", "द्वारका धीश", "राधा",
  "वासुदेव", "परम आत्मा", "राधा",
  "पार्थ सारथी", "चक्र धारी", "राधा",
  "जनार्दन", "केशव", "राधा",
  "श्री दामोदर", "जगन्नाथ", "राधा",
  "व्रज प्रिय", "गोपेश", "राधा",
  "कृष्ण कांत", "श्री विष्णु", "राधा",
  "मुरली माधव", "हरि नाम", "राधा",
  "विष्णु मूर्ति", "श्याम सुन्दर", "राधा",
  "देवकी सुत", "व्रज नाथ", "राधा",
  "जगदीश", "हरि वंश", "राधा",
  "गोकुल चंद्र", "बृजेश", "राधा",
  "यशोदा किशन", "माखन लाल", "राधा",
  "रास बिहारी", "नट नागर", "राधा",
  "गिरिराज धारी", "कन्हैया लाल", "राधा",
  "दया निधि", "भक्त वत्सल", "राधा",
  "माधु सूदन", "हरि प्रिय", "राधा",
  "चतुर्भुज", "हरि नायक", "राधा",
  "गोकुल नाथ", "व्रज नायक", "राधा",
  "कृष्ण चंद्र", "हरि मोहन", "राधा",
  "राधा पति", "गिरिराज किशोर", "राधा",
  "अनंत कृष्ण", "व्रज विहारी", "राधा",
  "हरि कांत", "प्रेम नाथ", "राधा",
  "वासुदेव कुमार", "यदु नंदन", "राधा",
  "हरि गोपाल", "हरि किशन", "राधा",
  "हरि चरण", "हरि माधव", "राधा",
  "हरि रूप", "हरि श्याम", "राधा",
  "हरि नाथ", "हरि कृष्ण", "राधा",

  // 🌸 संस्कृत व भक्ति ग्रंथों से विशेष नाम 🌸
  "माधवेश्वर", "रुक्मिणी प्रिय", "राधा",
  "द्वारका नाथ", "गोपि वल्लभ", "राधा",
  "क्लेश नाशक", "व्रज मोहन", "राधा",
  "अच्युत", "अनन्त नाथ", "राधा",
  "व्रज वल्लभ", "करुणा निधान", "राधा",
  "योगेश्वर", "जगद्गुरु", "राधा",
  "गोपी प्रिय", "हरि माधव", "राधा",
  "रासेश्वर", "प्रियतम श्याम", "राधा",
  "चक्रपाणि", "पद्म नाभ", "राधा",
  "विष्णु नाथ", "कृष्ण कांत", "राधा",
  "राधा रमण", "रास राज", "राधा",
  "रुक्मिणी नाथ", "माधव मुरारी", "राधा",


  "राधा", "रासेश्वरी", "रम्या", "कृष्णमत्राधि देवता", 
  "सर्वाद्या", "सर्ववन्द्या", "वृंदावन विहारिणी", "वृन्दा राधा",
  "रमा", "अशेष गोपीमण्डल पूजिता", "सत्या", "सत्यपरा", 
  "सत्य भामा", "श्रीकृष्ण वल्लभा", "वृषभानु सुता", "गोपी",
  "मूल प्रकृति", "ईश्वरी", "गान्धर्वा", "राधिका", "आरम्या",
  "रुक्मिणी", "परमेश्वरी", "परात्परतरा", "पूर्णा", "पूर्णचन्द्र विमानना", 
  "भुक्ति मुक्तिप्रदा", "भवव्याधि विनाशिनी"

];

  const colors = [
    "radial-gradient(circle at 30% 30%, rgba(30,50,160,0.85), rgba(10,20,60,0.95))",
    "radial-gradient(circle at 30% 30%, rgba(90,30,130,0.85), rgba(40,10,70,0.95))",
    "radial-gradient(circle at 30% 30%, rgba(20,110,60,0.85), rgba(10,40,25,0.95))",
    "radial-gradient(circle at 30% 30%, rgba(150,30,60,0.85), rgba(70,10,30,0.95))",
    "radial-gradient(circle at 30% 30%, rgba(30,90,100,0.85), rgba(10,40,50,0.95))",
    "radial-gradient(circle at 30% 30%, rgba(180,120,30,0.9), rgba(100,60,10,0.95))",
    "radial-gradient(circle at 30% 30%, rgba(15,45,95,0.9), rgba(5,20,50,0.95))",
    "radial-gradient(circle at 30% 30%, rgba(90,20,60,0.9), rgba(40,10,30,0.95))"
  ];
  // Click -> spawn bubble
  document.addEventListener('click', function (e) {
    // create
    const bubble = document.createElement('div');
    bubble.className = 'bubble';

    // random size (48 - 84 px)
    const size = Math.round(62 + Math.random() * 36);
    bubble.style.setProperty('--b-size', size + 'px');

    // random float duration (6s - 10s)
    const duration = (6 + Math.random() * 4).toFixed(2);
    bubble.style.setProperty('--b-duration', duration + 's');

    // random rotation duration (3s - 5.5s)
    const rot = (3 + Math.random() * 2.5).toFixed(2);
    bubble.style.setProperty('--b-rot', rot + 's');

    // position - center bubble on click
    const left = e.clientX - size / 2;
    // keep inside viewport horizontally
    const clampedLeft = Math.max(6, Math.min(left, window.innerWidth - size - 6));
    bubble.style.left = clampedLeft + 'px';

    // optional small horizontal drift via CSS (random)
    const drift = Math.round(-40 + Math.random() * 80); // -40..+40 px
    bubble.style.transform = `translateX(${drift}px)`; // initial X drift; floatUp anim will add translateY
    const bg = colors[Math.floor(Math.random()*colors.length)];
    bubble.style.background = bg;
    // inner rotating container
    const word = words[Math.floor(Math.random()*words.length)];
    const inner = document.createElement('div');
    inner.className = 'bubble-inner';
    const parts = word.split(" ");
    parts.forEach((part)=>{
      const txt = document.createElement('span');
      txt.style.fontSize = Math.min(size/3, 26) + "px";
      txt.textContent = part;
      inner.appendChild(txt);
    });

    const starCount = 3 + Math.floor(Math.random()*3);
    for(let i=0;i<starCount;i++){
      const star = document.createElement('div');
      star.className = 'star';
      const starSize = (Math.random()*3 + 3);
      star.style.width = starSize + "px";
      star.style.height = starSize + "px";
      star.style.left = (Math.random()*size*0.7 - size*0.35 + size/2) + "px";
      star.style.top  = (Math.random()*size*0.7 - size*0.35 + size/2) + "px";
      const twinkleSpeed = (1 + Math.random()*1.5).toFixed(2);
      star.style.animation = `twinkle ${twinkleSpeed}s ease-in-out infinite`;
      inner.appendChild(star);
    }
    bubble.appendChild(inner);
    // append
    document.body.appendChild(bubble);

    // remove after animation finishes (duration + small buffer)
    const removeAfter = Math.ceil((parseFloat(duration) + 0.6) * 1000);
    setTimeout(() => {
      bubble.remove();
    }, removeAfter);

    if(Math.random() < 0.3){
      const shoot = document.createElement('div');
      shoot.className = 'shooting-star';
      shoot.style.left = Math.random() * window.innerWidth/2 + "px";
      shoot.style.top  = Math.random() * window.innerHeight/2 + "px";
      document.body.appendChild(shoot);
      setTimeout(()=> shoot.remove(), 2000);
    }
  });

  // Improve touch on mobile: prevent double-tap zoom (optional)
  document.addEventListener('touchstart', function(){}, {passive:true});
</script>

  <style>
    :root{
      --bg:#0f172a;         /* slate-900 */
      --card:#111827;       /* gray-900 */
      --card-2:#1f2937;     /* gray-800 */
      --text:#e5e7eb;       /* gray-200 */
      --muted:#9ca3af;      /* gray-400 */
      --accent:#f59e0b;     /* amber-500 */
      --accent-2:#22c55e;   /* green-500 */
      --danger:#ef4444;     /* red-500 */
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, 'Helvetica Neue', Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1000px 600px at 50% -10%, #1e293b 0%, var(--bg) 60%);
      color:var(--text); display:flex; min-height:100dvh; align-items:center; justify-content:center;
    }
    .app{ width:min(980px, 100%); padding:20px; }
    .grid{ display:grid; gap:16px; grid-template-columns: 1fr; }
    @media (min-width: 900px){ .grid{ grid-template-columns: 1.2fr 1fr; } }
    .card{ background:linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%); border:1px solid #334155; border-radius:20px; box-shadow: 0 10px 30px #00000055; }
    .pane{ padding:20px; }

    .title{ display:flex; align-items:center; gap:10px; }
    .title h1{ margin:0; font-weight:700; letter-spacing:.3px; font-size:clamp(20px, 3vw, 28px); }
    .subtitle{ margin:4px 0 0; color:var(--muted); font-size:14px }

    .image-wrap{ position:relative; overflow:hidden; border-radius:16px; border:1px solid #334155 }
    .image-wrap img{ width:100%; height:420px; object-fit:cover; display:block; background:#0b1220 }
    .image-actions{ display:flex; gap:8px; margin-top:10px; align-items:center; flex-wrap:wrap }
    .btn{ -webkit-tap-highlight-color:transparent; cursor:pointer; user-select:none; border:none; border-radius:14px; padding:12px 16px; font-weight:600; font-size:14px; background:#0b1220; color:var(--text); border:1px solid #334155; box-shadow:0 2px 0 #0008 inset; transition:.15s transform,.15s filter }
    .btn:hover{ filter:brightness(1.05) }
    .btn:active{ transform:translateY(1px) }
    .btn.primary{ background:linear-gradient(180deg, #fbbf24, var(--accent)); color:#1f2937; border-color:#f59e0b }
    .btn.success{ background:linear-gradient(180deg, #34d399, var(--accent-2)); color:#052e1a; border-color:#10b981 }
    .btn.danger{ background:linear-gradient(180deg, #f87171, var(--danger)); color:#300; border-color:#ef4444 }
    .btn.ghost{ background:#0b1220; color:var(--text) }
    .btn.small{ padding:8px 10px; border-radius:10px; font-weight:600; font-size:12px }

    .counter-card{ padding:24px; text-align:center; display:grid; gap:14px }
    .count{ font-size: clamp(48px, 10vw, 96px); line-height:1; font-weight:800; letter-spacing:1px }
    .mantra{ font-size: clamp(16px, 2.8vw, 22px); color:var(--muted) }

    .rounds{ display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; text-align:center }
    .badge{ background:#0b1220; border:1px solid #334155; border-radius:12px; padding:10px; font-size:12px; color:var(--muted) }
    .badge strong{ display:block; color:var(--text); font-size:18px }

    .tap-area{ border:1px dashed #334155; border-radius:16px; padding:14px; font-size:13px; color:var(--muted) }

    .footer{ display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap }
    .switch{ display:inline-flex; gap:8px; align-items:center; font-size:13px; color:var(--muted) }
    .switch input{ width:42px; height:22px; appearance:none; background:#0b1220; border:1px solid #334155; border-radius:999px; position:relative; outline:none; cursor:pointer }
    .switch input:checked{ background: #065f46 }
    .switch input:before{ content:""; position:absolute; inset:3px; width:16px; height:16px; border-radius:50%; background:#94a3b8; transform:translateX(0); transition:.15s transform }
    .switch input:checked:before{ transform: translateX(20px); background:#34d399 }

    .history{ margin-top:12px; font-size:13px; color:var(--muted) }
    .history ul{ margin:8px 0 0 18px }

    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0b1220; border:1px solid #334155; border-radius:6px; padding:2px 6px; font-size:.9em; color:#cbd5e1 }
    .link{ color:#93c5fd; text-decoration:none }
  </style>
</head>
<body>
  <div class="app">
    <div class="title">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 2c1.2 2.4 3 4 6 4-1.2 2.4-3 4-6 4-3 0-4.8-1.6-6-4 3 0 4.8-1.6 6-4Zm0 12c1.2 2.4 3 4 6 4-1.2 2.4-3 4-6 4-3 0-4.8-1.6-6-4 3 0 4.8-1.6 6-4Z" fill="#fbbf24"/>
      </svg>
      <div>
        <h1>Naam Japa Counter</h1>
        <p class="subtitle">Focus on the Divine Name — tap anywhere or press <span class="kbd">Space</span>.</p>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Image and controls -->
      <div class="card pane">
        <div class="image-wrap">
          <img id="photo" alt="Radha–Krishna image" />
        </div>
        <div class="image-actions">
          <input class="btn small" type="file" id="fileInput" accept="image/*" aria-label="Upload Radha–Krishna image" />
          <button class="btn ghost small" id="fitContain">Fit</button>
          <button class="btn ghost small" id="fitCover">Fill</button>
          <button class="btn small" id="clearImage">Remove</button>
        </div>
        <p class="tap-area">Tip: You can set your own Radha–Krishna photo using <b>Upload</b>. The image is saved on your device (no internet) and restored when you reopen.</p>
      </div>
      <div class="scene-shadow" aria-hidden="true"></div>

      <!-- RIGHT: Counter -->
      <div class="card counter-card" id="counterCard" role="region" aria-label="Japa Counter">
        <div class="mantra" id="mantra"> हरे कृष्णा हरे कृष्णा कृष्णा कृष्णा हरे हरे • हरे रामा हरे रामा रामा रामा हरे हरे |</div>
        <div class="count" id="count">0</div>

        <div class="rounds">
          <div class="badge"><strong id="bead">0</strong>Bead (of <span id="beadsPerMala">108</span>)</div>
          <div class="badge"><strong id="malas">0</strong>Malas completed</div>
          <div class="badge"><strong id="today">0</strong>Today</div>
          <div class="badge"><strong id="total">0</strong>Total</div>
        </div>

        <div style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:4px">
          <button class="btn primary" id="btnPlus" aria-label="Count one bead"><span style="font-size:18px">✚</span> Count</button>
          <button class="btn" id="btnUndo" aria-label="Undo last count"><span style="font-size:18px">↶</span> Undo</button>
          <button class="btn danger" id="btnReset" aria-label="Reset session">Reset</button>
          <button class="btn success" id="btnCompleteMala" aria-label="Complete mala">Complete 108</button>
        </div>

        <div class="footer">
          <div class="switch"><label for="sound">Sound</label><input id="sound" type="checkbox" /></div>
          <div class="switch"><label for="vibrate">Vibration</label><input id="vibrate" type="checkbox" checked /></div>
          <div class="switch"><label for="beads">Beads per mala</label>
            <select id="beads" class="btn small" aria-label="Select beads per mala">
              <option value="108" selected>108</option>
              <option value="54">54</option>
              <option value="27">27</option>
            </select>
          </div>
        </div>

        <div class="history" id="history"></div>
        <div class="history">Shortcuts: <span class="kbd">Space/Enter</span> count, <span class="kbd">Z</span> undo, <span class="kbd">R</span> reset.</div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const el = (id)=>document.getElementById(id);

    const countEl = el('count');
    const beadEl = el('bead');
    const malasEl = el('malas');
    const todayEl = el('today');
    const totalEl = el('total');
    const historyEl = el('history');

    const beadsSel = el('beads');
    const beadsPerMalaEl = el('beadsPerMala');

    const btnPlus = el('btnPlus');
    const btnUndo = el('btnUndo');
    const btnReset = el('btnReset');
    const btnCompleteMala = el('btnCompleteMala');

    const card = el('counterCard');

    const soundChk = el('sound');
    const vibrateChk = el('vibrate');

    const fileInput = el('fileInput');
    const photo = el('photo');
    const fitContain = el('fitContain');
    const fitCover = el('fitCover');
    const clearImage = el('clearImage');

    const LS = {
      COUNTS: 'japa_counts_v1',
      IMAGE: 'japa_image_v1',
      SETTINGS: 'japa_settings_v1'
    };

    // --- State ---
    let count = 0;             // current session count
    let history = [];          // timestamps of counts
    let beadsPerMala = 108;

    const todayKey = new Date().toISOString().slice(0,10);
    const allCounts = JSON.parse(localStorage.getItem(LS.COUNTS) || '{}');

    // Load settings
    try{
      const settings = JSON.parse(localStorage.getItem(LS.SETTINGS) || '{}');
      beadsPerMala = settings.beadsPerMala || 108;
      beadsSel.value = String(beadsPerMala);
      beadsPerMalaEl.textContent = beadsPerMala;
      soundChk.checked = !!settings.sound;
      vibrateChk.checked = settings.vibrate !== false;
      const img = localStorage.getItem(LS.IMAGE);
      if(img){ photo.src = img; } else { setFallbackImage(); }
      photo.style.objectFit = settings.fit || 'cover';
    }catch{ setFallbackImage(); }

    function setFallbackImage(){
      photo.alt = 'Radha–Krishna';
      photo.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="900" height="600">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#111827"/>
              <stop offset="100%" stop-color="#1f2937"/>
            </linearGradient>
          </defs>
          <rect fill="url(#g)" width="100%" height="100%"/>
          <text x="50%" y="45%" fill="#fbbf24" font-size="48" text-anchor="middle" font-family="Segoe UI, Arial">Radha–Krishna</text>
          <text x="50%" y="60%" fill="#cbd5e1" font-size="24" text-anchor="middle" font-family="Segoe UI, Arial">Upload your photo</text>
        </svg>
      `);
      photo.style.objectFit = 'cover';
    }

    // Load today's count
    count = (allCounts[todayKey] || 0);
    updateUI();

    // --- Helpers ---
    function totalAcrossDays(){
      try{
        return Object.values(allCounts).reduce((a,b)=>a+(Number(b)||0),0);
      }catch{ return count; }
    }

    function updateUI(){
      countEl.textContent = count;
      beadEl.textContent = (count % beadsPerMala);
      malasEl.textContent = Math.floor(count / beadsPerMala);
      todayEl.textContent = count;
      totalEl.textContent = totalAcrossDays();
      beadsPerMalaEl.textContent = beadsPerMala;
      renderHistory();
    }

    function persist(){
      allCounts[todayKey] = count;
      localStorage.setItem(LS.COUNTS, JSON.stringify(allCounts));
    }

    function playClick(){
      if(!soundChk.checked) return;
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type='sine'; o.frequency.value=660;
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.3, ctx.currentTime+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.08);
        o.connect(g).connect(ctx.destination);
        o.start(); o.stop(ctx.currentTime+0.09);
      }catch{}
    }

    function vibrate(ms=15){ if(vibrateChk.checked && navigator.vibrate) navigator.vibrate(ms); }

    function pushHistory(type){
      history.push({t: Date.now(), type});
      if(history.length>500) history.shift();
      renderHistory();
    }

    function renderHistory(){
      if(history.length===0){
        historyEl.innerHTML = '<em>No actions yet in this session.</em>';
        return;
      }
      const rows = history.slice(-8).map(h=>{
        const d = new Date(h.t); const time = d.toLocaleTimeString();
        const label = h.type==='+'? 'Count' : h.type==='undo'? 'Undo' : h.type==='mala'? 'Complete 108' : 'Reset';
        return `<li>${time}: ${label}</li>`;
      }).join('');
      historyEl.innerHTML = `<div>Recent actions:</div><ul>${rows}</ul>`;
    }

    function saveSettings(){
      const settings = {
        beadsPerMala,
        sound: soundChk.checked,
        vibrate: vibrateChk.checked,
        fit: photo.style.objectFit || 'cover'
      };
      localStorage.setItem(LS.SETTINGS, JSON.stringify(settings));
    }

    // --- Actions ---
    function add(n=1){
      count = Math.max(0, count + n);
      pushHistory(n>0?'+':'undo');
      persist(); updateUI(); playClick(); vibrate();
    }

    function undo(){ add(-1); }

    function reset(){
      if(confirm('Reset today\'s count? This only clears the current day.')){
        count = 0; pushHistory('reset'); persist(); updateUI(); vibrate(30);
      }
    }

    function completeMala(){
      const remainder = beadsPerMala - (count % beadsPerMala);
      if(remainder === 0){
        add(beadsPerMala);
      } else {
        add(remainder);
      }
      pushHistory('mala');
    }

    // --- Events ---
    btnPlus.addEventListener('click', ()=> add(1));
    btnUndo.addEventListener('click', undo);
    btnReset.addEventListener('click', reset);
    btnCompleteMala.addEventListener('click', completeMala);

    // Tap anywhere on the card to count
    card.addEventListener('click', (e)=>{
      const tag = (e.target.closest('button,input,select,label,svg,path')||{}).tagName;
      if(tag) return; // don't hijack clicks on controls
      add(1);
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if(['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) return;
      if(e.code==='Space' || e.code==='Enter'){ e.preventDefault(); add(1); }
      else if((e.key==='z' || e.key==='Z')){ undo(); }
      else if((e.key==='r' || e.key==='R')){ reset(); }
    });

    // Beads per mala
    beadsSel.addEventListener('change', ()=>{
      beadsPerMala = Number(beadsSel.value)||108; beadsPerMalaEl.textContent = beadsPerMala; saveSettings(); updateUI();
    });

    soundChk.addEventListener('change', saveSettings);
    vibrateChk.addEventListener('change', saveSettings);

    // Image upload
    fileInput.addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{ photo.src = reader.result; localStorage.setItem(LS.IMAGE, reader.result); };
      reader.readAsDataURL(f);
    });

    fitContain.addEventListener('click', ()=>{ photo.style.objectFit='contain'; saveSettings(); });
    fitCover.addEventListener('click', ()=>{ photo.style.objectFit='cover'; saveSettings(); });
    clearImage.addEventListener('click', ()=>{
      if(confirm('Remove the saved image?')){ localStorage.removeItem(LS.IMAGE); setFallbackImage(); saveSettings(); }
    });

    // First paint
    updateUI();
  })();
  </script>
</body>
</html>
